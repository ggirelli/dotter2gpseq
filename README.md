**Note! As of 2018-03-15 `dotter2gpseq` was merged with [`gpseq-img-py`](http://github.com/ggirelli/gpseq-img-py) and is not maintained anymore.**

dotter2gpseq (not maintained)
=============

A collection of scripts that can be used in combination with pygpseq to perform advanced operations.

Each script needs to be able to load the `pygpseq` library. Either install it systemwide or place a link to the `pygpseq` folder in the same directory as the script (e.g., `ln -s REPOFOLDER/pygpseq ./pygpseq`).

### dotter2gpseq.py

**dotter2gpseq.py** requires the table output of DOTTER, with the FISH dots coordinates in the `x`, `y` and `z` columns, and the NM address in the `File` column. Then, prepare a folder containing the DNA staining channels (deconvolved) with file name in DOTTER notation (e.g., `dapi_001_cmle.tif`).

The script will add 7 columns: `angle`, `Allele`, `cellID`, `lamin_dist`, `lamin_dist_norm`, `centr_dist` and `centr_dist_norm`.

The `Allele` column contains allele labeling:

- No value: dot outside of cells
- -1: more than 2 dots per cell/channel
- 0: less than 2 dots per cell/channel
- 1: more central dot
- 2: more peripheral dot

The `angle` column contains the angle between each allele pair and the nucleus center of mass.

Lamina distance and center distance are calculated using an anisotropic euclidean transform based on the specified aspect (`-a`). Lamina is defined as the first black (background) pixels outside of the nucleus. Center is defined as the nuclear pixels most distant from the lamina. Previous versions of the script extrapolated the center distance from the normalized lamin distance instead.

Distances from center and lamina are normalized on their sum, for each dot. Previous versions of the script normalized over the maximum radius of the nucleus, *assuming a spherical shape*.

* Also, an option (`-a Z Y X`) is available to specify the voxel aspect ratio.
* Use `-t` to specify the number of threads to be used for paralelization.
* Use `--dilate` to specify the number of dilation operations to perform. The dilations are performed nucleus-wise, while the nuclear masked is saved for a general dilation (for simplicity).
* Use `./dotter2gpseq.py -h` for more details.

```
usage: dotter2gpseq.py [-h] [-a Z Y X] [-d sep] [-D npx] [-t nthreads]
                       [-m folder] [-M prefix] [-P axis_fraction] [--labeled]
                       [--compressed] [--annotate-compart] [--noplot]
                       [--no-compart-plot] [--version]
                       dotCoords imgFolder outFolder

Calculate radial position of dots in cells.

The G1 selection is actually a selection of the most represented cell sub-
-population based on flatten area and integral of DNA stain intensity. In other
words, it will selected the most represented cell cycle phase in your cell
population (generally, G1). Images are expected to follow DOTTER filename
notation: "channel_series.tif".

If you already segmented your images (i.e., produced masks), provide the path to
the folder containing the masks using -m, and the prefix for the mask name with
-m. For example, with '-m /ex/mask_dir/ -M mask_', in the case of the image
file '1.tif', the script will look for the mask at "/ex/mask_dir/mask_1.tif".
If the mask can be found, it will be used, otherwise it will be generated and
then saved. This can be used also to export masks as tifs to the folder
specified with -m.

If your cells have ellipsoidal shape, use the --annotate-compartments flag to
assign each dot to the poles (2), bottom center (1) or top center (0)
compartments. The pole compartments are defined as the 20%% of the whole volume,
by cutting perpendicularly to the major axis. Information on goodnes of fit is
reported and a plot is provided with each nucleus rotated and centered. Plotting
can be turned off generally with the --noplot flag, and specifically with the
--no-compartment-plot flag.

positional arguments:
  dotCoords             Dot coordinates table generated by DOTTER.
  imgFolder             Path to folder containing deconvolved tiff images.
  outFolder             Path to output folder (created if does not exist).

optional arguments:
  -h, --help            show this help message and exit
  -a Z Y X, --aspect Z Y X
                        Physical size of Z, Y and X voxel sides. Default:
                        300.0 130.0 130.0
  -d sep, --delim sep   Input table delimiter. Default: ','
  -D npx, --dilate npx  Number of pixels for nuclear mask dilation. It is
                        automatically scaled based on the specified aspect to
                        be isotropic in 3D. Default: 0
  -t nthreads, --threads nthreads
                        Number of threads for parallelization. Default: 1
  -m folder, --mask-folder folder
                        Path to folder containing binarized/labeled images.
                        Masks will be saved to this folder if missing.
  -M prefix, --mask-prefix prefix
                        Prefix for mask selection. Default: 'mask_'.
  -P axis_fraction, --pole axis_fraction
                        Fraction of the major nuclear axis to identify a pole.
                        Should be in the [0, .5] interval. Default: .25.
  --labeled             Export labeled masks instead of binary.
  --compressed          Generate compressed TIF binary masks (not compatible
                        with ImageJ.
  --annotate-compart    Assign dots to nuclear compartments, only for
                        ellipsoidal nuclei.
  --noplot              Do not produce any plots.
  --no-compart-plot     Do not produce compartments-related plots.
  --version             show program's version number and exit
```

### dotter2gpseq_merge.R

Useful to merge the output generated by multiple runs of `dotter2gpseq.py`, possibly on different cell lines, etc...

```
usage: dotter2gpseq_merge.R [--] [--help] [--opts OPTS] [--meta META] [--indir INDIR] [--outdir OUTDIR] [--aspect ASPECT] [--threads THREADS] 

Description: merge dotter2gpseq.py output, add dataset and
cell type information. The software looks for dotter2gpseq.py output in
subfolders of the specified input directories. These subfolders must be named as
dataset_series, with series being in XXX format with leading zeros. Please, note
that the channel is enforced as lower-case by the merge operation.

Example 1: output in current directory.
./merge_data.R -m meta.tsv -i HAP1/dots_auto IMR90/dots_auto

Example 2: output to "/home/user/out" directory.
./merge_data.R -m meta.tsv -i HAP1/dots_auto IMR90/dots_auto
  -o /home/user/out


flags:
  -h, --help      show this help message and exit

optional arguments:
  -x, --opts OPTS     RDS file containing argument values
  -m, --meta META     Metadata table. Needed columns: dataset, series, cell_line, set_label, probe_label.
  -i, --indir INDIR     List of input folders with dotter2gpseq output as subfolders.
  -o, --outdir OUTDIR     Output folder, created if missing. Default to current one. [default: .]
  -a, --aspect ASPECT     Physical size of Z, Y and X voxel sides. Default: 300.0 130.0 130.0 [default: (300,130,130)]
  -t, --threads THREADS     Number of threads for parallelization. Default: 1 [default: 1]
```
